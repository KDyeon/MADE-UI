<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>폼 추가/삭제 예제</title>
    <title>mail-form</title>
    <link rel="stylesheet" type="text/css" href="maill.css">
    <link rel="stylesheet" type="text/css" href="common.css">
</head>

<body>
  <div id="mail">
            <input type="text" id="form-title" placeholder="[ TITLE ]">
            <div id="form-mail"></div>
            <center>

<div id="test">
    
    
</div>
      <div id="bott">
               <center>
                <button id="mail-prev" onclick="addForm()">미리보기</button>
                <button id="mail-submit" onclick="delForm()">확인</button>
                </center>
            </div>
            </center>
      </center>
      </div>
    <button id="addBtn" type="button">추가</button>
    <script src="node_modules/handlebars/dist/handlebars.min.js"></script>
    <script src="node_modules/jquery/dist/jquery.js"></script>
    <script src="node_modules/blueimp-file-upload/js/vendor/jquery.ui.widget.js"></script>
    <script src="node_modules/blueimp-load-image/js/load-image.all.min.js"></script>
    <script src="node_modules/blueimp-canvas-to-blob/js/canvas-to-blob.js"></script>
    <script src="node_modules/bootstrap/dist/js/bootstrap.js"></script>
    <script src="node_modules/blueimp-file-upload/js/jquery.iframe-transport.js"></script>
    <script src="node_modules/blueimp-file-upload/js/jquery.fileupload.js"></script>
    <script src="node_modules/blueimp-file-upload/js/jquery.fileupload-process.js"></script>
    <script src="node_modules/blueimp-file-upload/js/jquery.fileupload-image.js"></script>
    <script>
         "use strict"
                var count=0;
        
        let str = null;
        
        function createStr(count) {
            return str =`<div id="mail-form${count} style="margin-top:10%"">\
            사진: <input id="fileupload${count}" type="file" name="files" multiple><br>\
            <div id="#images-div${count}"></div>\
            상품명: <input id="title${count}" type="text"><br>\
            상품 상세: <textarea id='explain${count}' type='text'></textarea><br>\
            <a href="#" id="imgdel${count}">[상품사진 삭제하기]</a><br>\
            <button id='upload-btn${count}' type='button'>등록</button>\
            </div>`;
            
        }
        
       

        $('#addBtn').click((e) => {
            count++;
            createStr(count);
            console.log(count);
            if (count <= 9) {
                for (var i = 0; i <= count; i++) {
                    var addedDiv = document.createElement('div');
                    addedDiv.id = "mailform" + count;
                    
                    $('#test').append(str);
                
                    break;
                    //  document.baseForm.count.value = count;
                    // console.log(i);
                    
                }
                
            } else {
                alert('항목을 모두 추가하셨습니다.');
            };
        });
        
        
        $(`#fileupload${count}`).click((e)=>{
              $(`#fileupload${count}`).fileupload({
            url: '../mvc/mail/mailprev',
            dataType: 'json',
            sequentialUploads: true,
            singleFileUploads: false,
            autoUpload: false,
            disableImageResize: /Android(?!.*Chrome)|Opera/
                .test(window.navigator && navigator.userAgent),
            previewMaxWidth: 250,
            previewMaxHeight: 250,
            previewCrop: false,
            
            processalways: function(e, data) {
                console.log('업로드중.... ')
                console.log(count);
                console.log(data.files);
                
                imagesDiv.html("");
                for (var i = 0; i < data.files.length; i++) {
                    try {
                        if (data.files[i].preview.toDataURL) {
                            $("<img>")
                                .attr('src', data.files[i].preview.toDataURL())
                                .css('height', '250px')
                                .appendTo(imagesDiv)
                                .slideDown();
                            console.log('오ㅑ?');
                        }
                    } catch (err) {
                        console.log('업로드 실패');
                    }
                }
                $('#upload-btn').unbind("click");
                $('#upload-btn').click(function() {
                    data.submit();
                });
            },
            
            /*submit 전송*/
            submit: function(e, data) {
                console.log('전송 완료!!');
                data.formData = {
                    title: $(`#title${count}`).val(),
                    explain: $(`#explain${count}`).val()
                };
            },
            /*전송후 mailprev로 폼 전송 */
            done: function(e, data) {
                console.log('submit()...');
                console.log(data.result);
                $('<p/>').text("" + data.result.title).appendTo(document.body);
                $('<p/>').text("" + data.result.explain).appendTo(document.body);
                $.each(data.result.filenames, function(index, filename) {
                    $('<p/>').text(filename).appendTo(document.body);
                });
            }
        })
            
        })
      
       
    </script>
</body>
